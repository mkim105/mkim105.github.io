---
title: "C# for BIM 강좌"
date: 2020-07-22 22:00:00 -0400
categories: BIM
toc: true
toc_sticky: true
---

Udemy - Learn to program the Revit API by Boost Your BIM

## Section 1-9. External Command 생성과 Revit Add-In으로 적용하는 방법

1. 아래와 같이 VS(Visual Studio)를 이용하여 코드를 입력하고 빌드한다. 
```c#
using Autodesk.Revit.DB;
using Autodesk.Revit.UI;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace [ProjectName]
{
    [Autodesk.Revit.Attributes.Transaction(Autodesk.Revit.Attributes.TransactionMode.ReadOnly)]
    public class [ClassName] : IExternalCommand
    {
        static AddInId appId = new AddInId(new Guid("[GUID, 예: E4A27922-E4EC-48F4-A39E-4E1232D5319D]")); // Guid = Globally unique id, VS의 Tools->Create Guid->5번 포맷으로 생성
        public Result Execute(ExternalCommandData commandData, ref string message, ElementSet elementSet)
        {
            [기능에 대한 코드]
        }
    }
}
```

2. Visual Studio 안에서 만든 [ClassName].cs 탭 클릭 -> Open Containing Folder -> bin/debug/ 안의 [ProjectName].dll 파일을 찾는다.
  * [ProjectName].dll은 Visual Studio 안에서 만든 매크로이며, External Command로 쓰일 파일이다.
  * 파일의 경로 예) C:\Users\[UserName]\source\repos\[ProjectName]\[ProjectName]\bin\Debug\netstandard2.0\[ProjectName].dll
  
3. C:\ProgramData\Autodesk\Revit\Addins\[Years]에 [Any File Name].addin을 생성한다. 안의 코드 내용은 아래와 같다.

```xml
<?xml version="1.0" encoding="utf-8" standalone="no"?>
<RevitAddIns>
	<AddIn Type="Command">
		<Assembly>C:\Users\[UserName]\source\repos\[ProjectName]\[ProjectName]\bin\Debug\netstandard2.0\[ProjectName].dll</Assembly>
		<AddInId>[GUID]</AddInId>
		<FullClassName>[ProjectName].[ClassName]</FullClassName>
		<Text>[Revit Add-in 탭의 External Tools에 표시될 설명]</Text>
		<VendorId>BYBM</VendorId> // Commercial Developement시 필요한 ID
	</AddIn>
</RevitAddIns>	
```

4. Revit을 실행 후, Add-Ins 탭의 External Tools 메뉴에 있는 Add-In을 실행해본다. 끝..

## Section 1-10. 코드를 통해 Revit 모델을 변경하는 방법: Transaction class를 통하여

아래의 코드는 새로운 Family Type 및 Parameter와 Parameter value를 input하는 코드이다.
```c#
public void FamilyTypesParameters()
{
  Document doc = this.ActiveUIDocument.Document;
  if (!doc.IsFamilyDocument) // Revit에서 현재 활성화되어 있는 document가 FamilyDocument가 아니라면 아래 코드를 실행하지 않고 return한다.
  {
    return;
  }
  /*
  *코드를 통해 모델을 변경할 때마다 Transation class을 사용해야한다. 
  *변경이 진행되는 동안 다른 변경이 발생하지 않도록 Transaction은 모델을 잠근다. 
  *트랜잭션 코드는 매우 간단하다. 
  *'모델을 변경하는 코드'를 감싸고 있다
  *Transaction 코드 없이 매크로를 실행하려하면 오류가 발생한다. 
  */
  using (Transaction t = new Transaction(doc, "family test")) // Transaction(document, "transaction name")
  {
    t.Start(); // Transaction 시작
    FamilyManager mgr = doc.FamilyManager; // Family type과 parameter를 관리할 수 있는 FamilyManager를 변수로 저장.

    FamilyParameter param = mgr.AddParameter("New Parameter", BuiltInParameterGroup.PG_DATA, ParameterType.Text, false); // FamilyParameter Object로서의 param 변수 = ("Parameter Name", Parameter_group, Parameter_Type, bool(instace or type?))

    for (int i = 1; i < 5; i++) // i = 1 to 4 까지 
    {
      FamilyType newType = mgr.NewType(i.ToString()); // for문에 의한 i값(1,2,3,4)를 새로운 familytype으로 추가한다.
      mgr.CurrentType = newType; // CurrentType의 family type만이 FamilyManager 안에서 편집될 수 있기에 current type으로 바꿔준다.
      mgr.Set(param, "this value " + i); // parameter의 value를 세팅할 때 쓰인다. Set(FamilyParameter, Value)
    }

    t.Commit(); // Transaction 종료
  }
}
```
